/* appstate.js - Version: 1.2.4 - Author: Markuplab (Kirill Kaysarov) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.appstate=t()}}(function(){return function t(n,e,r){function u(i,o){if(!e[i]){if(!n[i]){var s="function"==typeof require&&require;if(!o&&s)return s(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var f=e[i]={exports:{}};n[i][0].call(f.exports,function(t){var e=n[i][1][t];return u(e?e:t)},f,f.exports,t,n,e,r)}return e[i].exports}for(var a="function"==typeof require&&require,i=0;i<r.length;i++)u(r[i]);return u}({1:[function(t,n,e){"use strict";function r(t,n){var e=n.tree,r=n.signal,i=n.start,o=n.promise,s=e.branches[t];return s||e.branches!==r.branches?s?Array.isArray(s)?u(t,s,n):a(t,s,n):void 0:(e.branches[t-1]&&(e.branches[t-1].duration=Date.now()-i),r.isExecuting=!1,void(o&&o.resolve(r)))}function u(t,n,e){var u=e.tree,a=e.args,i=e.signal,o=e.state,s=e.promise,p=e.start,l=e.services,h=n.map(function(t){var n=u.actions[t.actionIndex],e=f(a,t,o,!0),h=t.outputs?Object.keys(t.outputs):[];t.isExecuting=!0,t.args=x({},a);var d=c(n,h);return n.apply(null,e.concat(d.fn,l)),d.promise.then(function(n){if(t.hasExecuted=!0,t.isExecuting=!1,t.output=n.args,x(a,n.args),n.path){t.outputPath=n.path;var e=t.outputs[n.path];return r(0,{args:a,signal:i,state:o,start:p,promise:s,services:l,tree:{actions:u.actions,branches:e}})}})["catch"](function(t){return s.reject(t)})});return Promise.all(h).then(function(){return r(t+1,e)})}function a(t,n,e){var u=e.args,a=e.tree,i=e.signal,o=e.state,c=e.start,p=e.promise,l=e.services;try{var h=n,d=a.actions[h.actionIndex],g=f(u,h,o,!1),y=h.outputs?Object.keys(h.outputs):[];h.mutations=[],h.args=x({},u);var v=s(d,y);d.apply(null,g.concat(v,l));var b=v._result||{};if(x(u,b.args),h.isExecuting=!1,h.hasExecuted=!0,h.output=b.args,b.path){h.outputPath=b.path;var m=h.outputs[b.path],O=r(0,{args:u,signal:i,state:o,start:c,promise:p,services:l,tree:{actions:a.actions,branches:m}});return O&&O.then?O.then(function(){return r(t+1,e)}):r(t+1,e)}return r(t+1,e)}catch(A){p.reject(A)}}function i(t,n){return Array.isArray(n)&&n.forEach(function(n){t[n]=t.bind(null,n)}),t}function o(t,n){return function e(){var r="string"==typeof arguments[0]?arguments[0]:null,u=r?arguments[1]:arguments[0],a={path:r?r:t.defaultOutput,args:u};n?n(a):e._result=a}}function s(t,n){var e=o(t);return e=i(e,n)}function c(t,n){var e=null,r=new Promise(function(t){return e=t}),u=o(t,e);return i(u,n),{fn:u,promise:r}}function f(t,n,e,r){var u=p(e,n,r);return[t,u]}function p(t,n,e){var r=["apply","concat","deepMerge","push","merge","unset","set","splice","unshift"],u=["get","exists"],a=[];return e?a=a.concat(u):(a=a.concat(r),a=a.concat(u)),a.reduce(function(e,r){var u=t[r].bind(t);return e[r]=function(){for(var t=arguments.length,e=Array(t),a=0;t>a;a++)e[a]=arguments[a];var i=[],o=e[0];return Array.isArray(o)?i=e.shift():"string"==typeof o&&(i=[e.shift()]),0===e.length?u.apply(null,[i.slice()]):(n.mutations.push({name:r,path:i.slice(),args:e}),u.apply(null,[i.slice()].concat(e)))},e},Object.create(null))}function l(t){var n=[],e=h(t,[],[],n,!1);return{actions:n,branches:e}}function h(t){for(var n=arguments.length,e=Array(n>1?n-1:0),r=1;n>r;r++)e[r-1]=arguments[r];return Array.isArray(t)?d.apply(null,[t].concat(e)):g.apply(null,[t].concat(e))}function d(t,n,e,r,u){return t=t.slice(),u=!u,t.map(function(n,a){e.push(a);var i=h(n,t,e,r,u);return e.pop(),i}).filter(function(t){return!!t})}function g(t,n,e,r,u){var a={name:b(t),args:{},output:null,duration:0,mutations:[],isAsync:!u,outputPath:null,isExecuting:!1,hasExecuted:!1,path:e.slice(),outputs:null,actionIndex:-1===r.indexOf(t)?r.push(t)-1:r.indexOf(t)},i=n[n.indexOf(t)+1];return Array.isArray(i)||"object"!=typeof i||(n.splice(n.indexOf(i),1),a.outputs=Object.keys(i).reduce(function(t,u){return e=e.concat("outputs",u),t[u]=h(i[u],n,e,r,!1),e.pop(),e.pop(),t},{})),a}function y(t){t.forEach(function(t,n){if("undefined"==typeof t||"string"==typeof t)throw new Error('\n            State: Action number "'+n+'" in signal does not exist.\n            Check that you have spelled it correctly!\n          ');Array.isArray(t)?y(t):"[object Object]"===Object.prototype.toString.call(t)&&Object.keys(t).forEach(function(n){y(t[n])})})}function v(t,n){try{JSON.stringify(t)}catch(e){n.reject("State - Could not serialize arguments to signal. Please check signal.")}}function b(t){var n=t.toString();return n=n.substr("function ".length),n=n.substr(0,n.indexOf("("))}function x(t,n){return n=n||{},Object.keys(n).reduce(function(e,r){return e[r]=n[r],t},t)}n.exports={create:function(t){return y(t),function(n){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],u=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return new Promise(function(a,i){var o={resolve:a,reject:i},s=Date.now();v(u,o);var c=l(t),f={args:u,branches:c.branches,isExecuting:!0,duration:0};r(0,{tree:c,args:u,signal:f,promise:o,start:s,state:n,services:e})})}}}},{}]},{},[1])(1)});