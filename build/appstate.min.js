/* appstate.js - Version: 1.2.1 - Author: Markuplab (Kirill Kaysarov) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.appstate=t()}}(function(){return function t(n,e,r){function u(s,i){if(!e[s]){if(!n[s]){var o="function"==typeof require&&require;if(!i&&o)return o(s,!0);if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var f=e[s]={exports:{}};n[s][0].call(f.exports,function(t){var e=n[s][1][t];return u(e?e:t)},f,f.exports,t,n,e,r)}return e[s].exports}for(var a="function"==typeof require&&require,s=0;s<r.length;s++)u(r[s]);return u}({1:[function(t,n,e){"use strict";function r(t,n){var e=n.tree,r=n.signal,s=n.start,i=n.promise,o=e.branches[t];return o||e.branches!==r.branches?void(o&&(Array.isArray(o)?u(t,o,n):a(t,o,n))):(e.branches[t-1]&&(e.branches[t-1].duration=Date.now()-s),r.isExecuting=!1,void(i&&i.resolve(r)))}function u(t,n,e){var u=e.tree,a=e.args,s=e.signal,i=e.state,o=e.promise,l=e.start,p=e.services,g=n.map(function(t){var n=u.actions[t.actionIndex],e=f(a,t,i,!0),g=t.outputs?Object.keys(t.outputs):[];t.isExecuting=!0,t.args=x({},a);var h=c(n,g);return n.apply(null,e.concat(h.fn,p)),h.promise.then(function(n){if(t.hasExecuted=!0,t.isExecuting=!1,t.output=n.args,x(a,n.args),n.path){var e=t.outputs[n.path];return r(0,{args:a,signal:s,state:i,start:l,promise:o,services:p,tree:{actions:u.actions,branches:e}})}})["catch"](function(t){return o.reject(t)})});return Promise.all(g).then(function(){return r(t+1,e)})}function a(t,n,e){var u=e.args,a=e.tree,s=e.signal,i=e.state,c=e.start,l=e.promise,p=e.services;try{var g=n,h=a.actions[g.actionIndex],d=f(u,g,i,!1),v=g.outputs?Object.keys(g.outputs):[];g.mutations=[],g.args=x({},u);var y=o(h,v);h.apply(null,d.concat(y,p));var m=y._result||{};if(x(u,m.args),g.isExecuting=!1,g.hasExecuted=!0,g.output=m.args,m.path){g.outputPath=m.path;var b=g.outputs[m.path],A=r(0,{args:u,signal:s,state:i,start:c,promise:l,services:p,tree:{actions:a.actions,branches:b}});return A&&A.then?m.then(function(){return r(t+1,e)}):r(t+1,e)}return r(t+1,e)}catch(O){l.reject(O)}}function s(t,n){return Array.isArray(n)&&n.forEach(function(n){t[n]=t.bind(null,n)}),t}function i(t,n){return function e(){var r="string"==typeof arguments[0]?arguments[0]:null,u=r?arguments[1]:arguments[0],a={path:r?r:t.defaultOutput,args:u};n?n(a):e._result=a}}function o(t,n){var e=i(t);return e=s(e,n)}function c(t,n){var e=null,r=new Promise(function(t){return e=t}),u=i(t,e);return s(u,n),{fn:u,promise:r}}function f(t,n,e,r){var u=l(e,n,r);return[t,u]}function l(t,n,e){var r=["apply","concat","deepMerge","push","merge","unset","set","splice","unshift"],u=["get","exists"],a=[];return e?a=a.concat(u):(a=a.concat(r),a=a.concat(u)),a.reduce(function(e,r){var u=t[r].bind(t);return e[r]=function(){for(var t=arguments.length,e=Array(t),a=0;t>a;a++)e[a]=arguments[a];var s=[],i=e[0];return Array.isArray(i)?s=e.shift():"string"==typeof i&&(s=[e.shift()]),0===e.length?u.apply(null,[s.slice()]):(n.mutations.push({name:r,path:s.slice(),args:e}),u.apply(null,[s.slice()].concat(e)))},e},Object.create(null))}function p(t){var n=[],e=g(t,[],[],n,!1);return{actions:n,branches:e}}function g(t){for(var n=arguments.length,e=Array(n>1?n-1:0),r=1;n>r;r++)e[r-1]=arguments[r];return Array.isArray(t)?h.apply(null,[t].concat(e)):d.apply(null,[t].concat(e))}function h(t,n,e,r,u){return t=t.slice(),u=!u,t.map(function(n,a){e.push(a);var s=g(n,t,e,r,u);return e.pop(),s}).filter(function(t){return!!t})}function d(t,n,e,r,u){var a={name:m(t),args:{},output:null,duration:0,mutations:[],isAsync:!u,outputPath:null,isExecuting:!1,hasExecuted:!1,path:e.slice(),outputs:null,actionIndex:-1===r.indexOf(t)?r.push(t)-1:r.indexOf(t)},s=n[n.indexOf(t)+1];return Array.isArray(s)||"object"!=typeof s||(n.splice(n.indexOf(s),1),a.outputs=Object.keys(s).reduce(function(t,u){return e=e.concat("outputs",u),t[u]=g(s[u],n,e,r,!1),e.pop(),e.pop(),t},{})),a}function v(t,n){n.forEach(function(n,e){if("undefined"==typeof n||"string"==typeof n)throw new Error('\n            State: Action number "'+e+'" in signal "'+t+'" does not exist.\n            Check that you have spelled it correctly!\n          ');Array.isArray(n)&&v(t,n)})}function y(t,n,e){try{JSON.stringify(t)}catch(r){e.reject("State - Could not serialize arguments to signal. Please check signal "+n)}}function m(t){var n=t.toString();return n=n.substr("function ".length),n=n.substr(0,n.indexOf("("))}function x(t,n){return n=n||{},Object.keys(n).reduce(function(e,r){return e[r]=n[r],t},t)}n.exports={create:function(t,n){return v(t,n),function(e){var u=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return new Promise(function(s,i){var o={resolve:s,reject:i},c=Date.now();y(a,t,o);var f=p(n),l={name:t,args:a,branches:f.branches,isExecuting:!0,duration:0};r(0,{tree:f,args:a,signal:l,promise:o,start:c,state:e,services:u})})}}}},{}]},{},[1])(1)});