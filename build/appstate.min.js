/* appstate.js - Version: 1.1.0 - Author: Markuplab (Kirill Kaysarov) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.appstate=t()}}(function(){return function t(n,r,e){function u(s,i){if(!r[s]){if(!n[s]){var o="function"==typeof require&&require;if(!i&&o)return o(s,!0);if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var f=r[s]={exports:{}};n[s][0].call(f.exports,function(t){var r=n[s][1][t];return u(r?r:t)},f,f.exports,t,n,r,e)}return r[s].exports}for(var a="function"==typeof require&&require,s=0;s<e.length;s++)u(e[s]);return u}({1:[function(t,n,r){"use strict";function e(t,n){var r=n.tree,e=n.signal,s=n.start,i=n.promise,o=r.branches[t];return o||r.branches!==e.branches?void(o&&(Array.isArray(o)?u(t,o,n):a(t,o,n))):(r.branches[t-1]&&(r.branches[t-1].duration=Date.now()-s),e.isExecuting=!1,void(i&&i.resolve(e)))}function u(t,n,r){var u=r.tree,a=r.args,s=r.signal,i=r.state,o=r.promise,l=r.start,p=r.services,g=n.map(function(t){var n=u.actions[t.actionIndex],r=f(a,t,i,!0);t.isExecuting=!0,t.args=b({},a);var g=c(n);return n.apply(null,r.concat(g.fn,p)),g.promise.then(function(n){if(t.hasExecuted=!0,t.isExecuting=!1,t.output=n.args,b(a,n.args),n.path){var r=t.outputs[n.path];return e(0,{args:a,signal:s,state:i,start:l,promise:o,tree:{actions:u.actions,branches:r}})}})["catch"](function(t){return o.reject(t)})});return Promise.all(g).then(function(){return e(t+1,r)})}function a(t,n,r){var u=r.args,a=r.tree,s=r.signal,i=r.state,c=r.start,l=r.promise,p=r.services;try{var g=n,h=a.actions[g.actionIndex],d=f(u,g,i,!1);g.mutations=[],g.args=b({},u);var y=o(h);h.apply(null,d.concat(y,p));var v=y._result||{};if(b(u,v.args),g.isExecuting=!1,g.hasExecuted=!0,g.output=v.args,v.path){g.outputPath=v.path;var m=g.outputs[v.path],x=e(0,{args:u,signal:s,state:i,start:c,promise:l,tree:{actions:a.actions,branches:m}});return x&&x.then?v.then(function(){return e(t+1,r)}):e(t+1,r)}return e(t+1,r)}catch(A){l.reject(A)}}function s(t,n){return t.outputs?Array.isArray(t.outputs)?t.outputs.forEach(function(t){n[t]=n.bind(null,t)}):Object.keys(t.outputs).forEach(function(t){n[t]=n.bind(null,t)}):(n.success=n.bind(null,"success"),n.error=n.bind(null,"error")),n}function i(t,n){return function r(){var e="string"==typeof arguments[0]?arguments[0]:null,u=e?arguments[1]:arguments[0],a={path:e?e:t.defaultOutput,args:u};n?n(a):r._result=a}}function o(t){var n=i(t);return n=s(t,n)}function c(t){var n=null,r=new Promise(function(t){return n=t}),e=i(t,n);return s(t,e),{fn:e,promise:r}}function f(t,n,r,e){var u=l(r,n,e);return[t,u]}function l(t,n,r){var e=["apply","concat","deepMerge","push","merge","unset","set","splice","unshift"],u=["get","exists"],a=[];return r?a=a.concat(u):(a=a.concat(e),a=a.concat(u)),a.reduce(function(r,e){var u=t[e].bind(t);return r[e]=function(){for(var t=arguments.length,r=Array(t),a=0;t>a;a++)r[a]=arguments[a];var s=[],i=r[0];return Array.isArray(i)?s=r.shift():"string"==typeof i&&(s=[r.shift()]),0===r.length?u.apply(null,[s.slice()]):(n.mutations.push({name:e,path:s.slice(),args:r}),u.apply(null,[s.slice()].concat(r)))},r},Object.create(null))}function p(t){var n=[],r=g(t,[],[],n,!1);return{actions:n,branches:r}}function g(t){for(var n=arguments.length,r=Array(n>1?n-1:0),e=1;n>e;e++)r[e-1]=arguments[e];return Array.isArray(t)?h.apply(null,[t].concat(r)):d.apply(null,[t].concat(r))}function h(t,n,r,e,u){return t=t.slice(),u=!u,t.map(function(n,a){r.push(a);var s=g(n,t,r,e,u);return r.pop(),s}).filter(function(t){return!!t})}function d(t,n,r,e,u){var a={name:m(t),args:{},output:null,duration:0,mutations:[],isAsync:!u,outputPath:null,isExecuting:!1,hasExecuted:!1,path:r.slice(),outputs:null,actionIndex:-1===e.indexOf(t)?e.push(t)-1:e.indexOf(t)},s=n[n.indexOf(t)+1];return Array.isArray(s)||"object"!=typeof s||(n.splice(n.indexOf(s),1),a.outputs=Object.keys(s).reduce(function(t,u){return r=r.concat("outputs",u),t[u]=g(s[u],n,r,e,!1),r.pop(),r.pop(),t},{})),a}function y(t,n){n.forEach(function(n,r){if("undefined"==typeof n||"string"==typeof n)throw new Error('\n            State: Action number "'+r+'" in signal "'+t+'" does not exist.\n            Check that you have spelled it correctly!\n          ');Array.isArray(n)&&y(t,n)})}function v(t,n,r){try{JSON.stringify(t)}catch(e){r.reject("State - Could not serialize arguments to signal. Please check signal "+n)}}function m(t){var n=t.toString();return n=n.substr("function ".length),n=n.substr(0,n.indexOf("("))}function b(t,n){return n=n||{},Object.keys(n).reduce(function(r,e){return r[e]=n[e],t},t)}n.exports={create:function(t,n){return y(t,n),function(r){var u=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return new Promise(function(s,i){var o={resolve:s,reject:i},c=Date.now();v(a,t,o);var f=p(n),l={name:t,args:a,branches:f.branches,isExecuting:!0,duration:0};e(0,{tree:f,args:a,signal:l,promise:o,start:c,state:r,services:u})})}}}},{}]},{},[1])(1)});