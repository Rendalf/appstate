/* appstate.js - Version: 1.0.0 - Author: Markuplab (Kirill Kaysarov) */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.appstate=t()}}(function(){return function t(n,r,e){function u(i,o){if(!r[i]){if(!n[i]){var s="function"==typeof require&&require;if(!o&&s)return s(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var f=r[i]={exports:{}};n[i][0].call(f.exports,function(t){var r=n[i][1][t];return u(r?r:t)},f,f.exports,t,n,r,e)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<e.length;i++)u(e[i]);return u}({1:[function(t,n,r){"use strict";function e(t,n){var r=n.tree,e=n.signal,i=n.start,o=n.promise,s=r.branches[t];return s||r.branches!==e.branches?s?Array.isArray(s)?u(t,s,n):a(t,s,n):void 0:(r.branches[t-1]&&(r.branches[t-1].duration=Date.now()-i),e.isExecuting=!1,void(o&&o.resolve(e)))}function u(t,n,r){var u=r.tree,a=r.args,i=r.signal,o=r.state,s=r.promise,l=r.start,p=n.map(function(t){var n=u.actions[t.actionIndex],r=f(a,t,o,!0);t.isExecuting=!0,t.args=b({},a);var p=c(n);return n.apply(null,r.concat(p.fn)),p.promise.then(function(n){if(t.hasExecuted=!0,t.isExecuting=!1,t.output=n.args,b(a,n.args),n.path){var r=t.outputs[n.path];return e(0,{args:a,signal:i,state:o,start:l,promise:s,tree:{actions:u.actions,branches:r}})}})});return Promise.all(p).then(function(){return e(t+1,r)})}function a(t,n,r){var u=r.args,a=r.tree,i=r.signal,o=r.state,c=r.start,l=r.promise;try{var p=n,g=a.actions[p.actionIndex],h=f(u,p,o,!1);p.mutations=[],p.args=b({},u);var d=s(g);g.apply(null,h.concat(d));var y=d._result||{};if(b(u,y.args),p.isExecuting=!1,p.hasExecuted=!0,p.output=y.args,y.path){p.outputPath=y.path;var v=p.outputs[y.path],y=e(0,{args:u,signal:i,state:o,start:c,promise:l,tree:{actions:a.actions,branches:v}});return y&&y.then?y.then(function(){return e(t+1,r)}):e(t+1,r)}return e(t+1,r)}catch(m){console.log(m.stack)}}function i(t,n){return t.outputs?Array.isArray(t.outputs)?t.outputs.forEach(function(t){n[t]=n.bind(null,t)}):Object.keys(t.outputs).forEach(function(t){n[t]=n.bind(null,t)}):(n.success=n.bind(null,"success"),n.error=n.bind(null,"error")),n}function o(t,n){return function r(){var e="string"==typeof arguments[0]?arguments[0]:null,u=e?arguments[1]:arguments[0],a={path:e?e:t.defaultOutput,args:u};n?n(a):r._result=a}}function s(t){var n=o(t);return n=i(t,n)}function c(t){var n=null,r=new Promise(function(t){return n=t}),e=o(t,n);return i(t,e),{fn:e,promise:r}}function f(t,n,r,e){var u=l(r,n,e);return[t,u]}function l(t,n,r){var e=["apply","concat","deepMerge","push","merge","unset","set","splice","unshift"],u=["get","exists"],a=[];r?a=a.concat(u):(a=a.concat(e),a=a.concat(u));var i=Object.create(null);return a.reduce(function(r,e){var u=t[e].bind(t);return r[e]=function(){for(var t=arguments.length,r=Array(t),a=0;t>a;a++)r[a]=arguments[a];var i=[],o=r[0];return Array.isArray(o)?i=r.shift():"string"==typeof o&&(i=[r.shift()]),0===r.length?u.apply(null,[i.slice()]):(n.mutations.push({name:e,path:i.slice(),args:r}),u.apply(null,[i.slice()].concat(r)))},r},i),i}function p(t){var n=[],r=g(t,[],[],n,!1);return{actions:n,branches:r}}function g(t){for(var n=arguments.length,r=Array(n>1?n-1:0),e=1;n>e;e++)r[e-1]=arguments[e];return Array.isArray(t)?h.apply(null,[t].concat(r)):d.apply(null,[t].concat(r))}function h(t,n,r,e,u){return t=t.slice(),u=!u,t.map(function(n,a){r.push(a);var i=g(n,t,r,e,u);return r.pop(),i}).filter(function(t){return!!t})}function d(t,n,r,e,u){if("function"==typeof t){var a={name:m(t),args:{},output:null,duration:0,mutations:[],isAsync:!u,outputPath:null,isExecuting:!1,hasExecuted:!1,path:r.slice(),outputs:null,actionIndex:-1===e.indexOf(t)?e.push(t)-1:e.indexOf(t)},i=n[n.indexOf(t)+1];return Array.isArray(i)||"object"!=typeof i||(n.splice(n.indexOf(i),1),a.outputs=Object.keys(i).reduce(function(t,u){return r=r.concat("outputs",u),t[u]=g(i[u],n,r,e,!1),r.pop(),r.pop(),t},{})),a}}function y(t,n){n.forEach(function(n,r){if("undefined"==typeof n||"string"==typeof n)throw new Error('\n            State: Action number "'+r+'" in signal "'+t+'" does not exist.\n            Check that you have spelled it correctly!\n          ');Array.isArray(n)&&y(t,n)})}function v(t,n){try{JSON.stringify(t)}catch(r){throw new Error("State - Could not serialize arguments to signal. Please check signal "+n)}}function m(t){var n=t.toString();return n=n.substr("function ".length),n=n.substr(0,n.indexOf("("))}function b(t,n){return n=n||{},Object.keys(n).reduce(function(t,r){return t[r]=n[r],t},t)}n.exports={create:function(t,n){return y(t,n),function(r){var u=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return new Promise(function(a,i){v(u,t);var o=p(n),s={name:t,args:u,branches:o.branches,isExecuting:!0,duration:0},c=Date.now(),f={resolve:a,reject:i};e(0,{tree:o,args:u,signal:s,promise:f,start:c,state:r})})}}}},{}]},{},[1])(1)});